# Progress Log

## Learnings
(Notes discovered during implementation)

## Decisions
- PRD rewritten from scratch with expanded scope: price + sentiment + fundamentals data sources
- Story IDs reset to US-001..US-703 (no phase prefix in Phase 0, phase-prefixed from Phase 1 onward)
- ML retraining is core to the system (Phase 5), not optional

## Integration Notes
(Cross-story dependencies and gotchas)

## Next Smallest Task
- US-005: Add SQLite database layer with schema migrations

---

## Iteration 1 — US-001: Create project skeleton
- What was done:
  - Created tests/conftest.py (was missing from scaffold)
  - Fixed mypy type error in migrations.py: `callable` → `Callable[[sqlite3.Connection], None]`
  - Added py.typed marker to src/smaps/ for mypy PEP 561 compliance
  - Added [tool.mypy] config to pyproject.toml (mypy_path, explicit_package_bases)
  - Verified: pip install -e . succeeds, mypy passes, all 9 tests pass
- Files affected: tests/conftest.py, src/smaps/migrations.py, src/smaps/py.typed, pyproject.toml, PRD.md
- Learnings for next cycles:
  - src layout + editable install causes mypy "found twice" error; fix with mypy_path = "src" + explicit_package_bases = true
  - Phase 0 scaffold was already largely built but PRD checkboxes were never ticked after rewrite
  - Use `Callable` from typing, not builtin `callable`, as a type annotation
---

## Iteration 2 — US-002: Add Makefile with test and lint targets
- What was done:
  - Added `lint` target (`ruff check src/ tests/`) and `typecheck` target (`mypy src/`) to Makefile
  - Added `ruff>=0.4` and `mypy>=1.0` to `[project.optional-dependencies] dev` in pyproject.toml
  - Removed stale pre-rewrite files from src/ root (learner.py, predictor.py, scheduler.py, validator.py, __init__.py) that were causing mypy failures — these were from the old project structure before the PRD rewrite
  - Verified: `make test` (9 passed), `make lint` (all checks passed), `make typecheck` (success) all exit 0
- Files affected: Makefile, pyproject.toml, PRD.md, src/__init__.py (deleted), src/learner.py (deleted), src/predictor.py (deleted), src/scheduler.py (deleted), src/validator.py (deleted)
- Learnings for next cycles:
  - Stale files in src/ root from pre-rewrite era cause mypy to fail; they were safely removed since the package lives at src/smaps/
  - ruff is a fast Python linter with zero config needed for basic linting
  - Makefile .PHONY list must include all non-file targets
---

## Iteration 3 — US-003: Add config loader with environment variable support
- What was done:
  - .env.example already existed with SMAPS_TICKERS, SMAPS_DB_PATH, SMAPS_LOG_LEVEL
  - src/smaps/config.py already existed with Settings class using pydantic-settings BaseSettings
  - test_config_defaults already existed verifying Settings() works with no env vars
  - Added test_config_env_overrides to verify SMAPS_* env var overrides work (monkeypatch)
  - Verified: make test (10 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - Many Phase 0 stories were pre-built during scaffold but lacked tests for all acceptance criteria
  - pydantic-settings BaseSettings with env_prefix handles env var parsing including JSON lists
  - monkeypatch.setenv is the clean way to test env var overrides in pytest
---

## Iteration 4 — US-004: Add structured logging with run_id
- What was done:
  - src/smaps/logging.py already existed with get_logger(name, run_id=None)
  - Format already included ISO timestamp (%Y-%m-%dT%H:%M:%S), level, name, and run_id
  - Existing test_get_logger verified name but not isinstance; added isinstance(logger, logging.Logger) checks
  - Added test_get_logger_output_format that captures stderr and verifies ISO timestamp, level, name, run_id, and message are all present in output
  - Verified: make test (11 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - logging.StreamHandler writes to stderr by default; use capfd to capture it
  - Use unique logger names in tests to avoid handler reuse from Python's global logger registry
  - Phase 0 modules were pre-built but needed AC-level test coverage to be marked complete
---
