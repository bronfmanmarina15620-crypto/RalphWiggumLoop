# Progress Log

## Learnings
(Notes discovered during implementation)

## Decisions
- PRD rewritten from scratch with expanded scope: price + sentiment + fundamentals data sources
- Story IDs reset to US-001..US-703 (no phase prefix in Phase 0, phase-prefixed from Phase 1 onward)
- ML retraining is core to the system (Phase 5), not optional

## Integration Notes
(Cross-story dependencies and gotchas)

## Next Smallest Task
- US-105: Add sentiment table and persistence

---

## Iteration 1 — US-001: Create project skeleton
- What was done:
  - Created tests/conftest.py (was missing from scaffold)
  - Fixed mypy type error in migrations.py: `callable` → `Callable[[sqlite3.Connection], None]`
  - Added py.typed marker to src/smaps/ for mypy PEP 561 compliance
  - Added [tool.mypy] config to pyproject.toml (mypy_path, explicit_package_bases)
  - Verified: pip install -e . succeeds, mypy passes, all 9 tests pass
- Files affected: tests/conftest.py, src/smaps/migrations.py, src/smaps/py.typed, pyproject.toml, PRD.md
- Learnings for next cycles:
  - src layout + editable install causes mypy "found twice" error; fix with mypy_path = "src" + explicit_package_bases = true
  - Phase 0 scaffold was already largely built but PRD checkboxes were never ticked after rewrite
  - Use `Callable` from typing, not builtin `callable`, as a type annotation
---

## Iteration 2 — US-002: Add Makefile with test and lint targets
- What was done:
  - Added `lint` target (`ruff check src/ tests/`) and `typecheck` target (`mypy src/`) to Makefile
  - Added `ruff>=0.4` and `mypy>=1.0` to `[project.optional-dependencies] dev` in pyproject.toml
  - Removed stale pre-rewrite files from src/ root (learner.py, predictor.py, scheduler.py, validator.py, __init__.py) that were causing mypy failures — these were from the old project structure before the PRD rewrite
  - Verified: `make test` (9 passed), `make lint` (all checks passed), `make typecheck` (success) all exit 0
- Files affected: Makefile, pyproject.toml, PRD.md, src/__init__.py (deleted), src/learner.py (deleted), src/predictor.py (deleted), src/scheduler.py (deleted), src/validator.py (deleted)
- Learnings for next cycles:
  - Stale files in src/ root from pre-rewrite era cause mypy to fail; they were safely removed since the package lives at src/smaps/
  - ruff is a fast Python linter with zero config needed for basic linting
  - Makefile .PHONY list must include all non-file targets
---

## Iteration 3 — US-003: Add config loader with environment variable support
- What was done:
  - .env.example already existed with SMAPS_TICKERS, SMAPS_DB_PATH, SMAPS_LOG_LEVEL
  - src/smaps/config.py already existed with Settings class using pydantic-settings BaseSettings
  - test_config_defaults already existed verifying Settings() works with no env vars
  - Added test_config_env_overrides to verify SMAPS_* env var overrides work (monkeypatch)
  - Verified: make test (10 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - Many Phase 0 stories were pre-built during scaffold but lacked tests for all acceptance criteria
  - pydantic-settings BaseSettings with env_prefix handles env var parsing including JSON lists
  - monkeypatch.setenv is the clean way to test env var overrides in pytest
---

## Iteration 4 — US-004: Add structured logging with run_id
- What was done:
  - src/smaps/logging.py already existed with get_logger(name, run_id=None)
  - Format already included ISO timestamp (%Y-%m-%dT%H:%M:%S), level, name, and run_id
  - Existing test_get_logger verified name but not isinstance; added isinstance(logger, logging.Logger) checks
  - Added test_get_logger_output_format that captures stderr and verifies ISO timestamp, level, name, run_id, and message are all present in output
  - Verified: make test (11 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - logging.StreamHandler writes to stderr by default; use capfd to capture it
  - Use unique logger names in tests to avoid handler reuse from Python's global logger registry
  - Phase 0 modules were pre-built but needed AC-level test coverage to be marked complete
---

## Iteration 5 — US-005: Add SQLite database layer with schema migrations
- What was done:
  - db.py already exported get_connection(db_path) and ensure_schema(conn)
  - migrations.py already had sequential migration list with Callable types
  - schema_migrations table already created with version tracking
  - ensure_schema already idempotent (CREATE TABLE IF NOT EXISTS + version check)
  - Existing tests verified table creation and idempotency
  - Added test_schema_migrations_tracks_version to explicitly verify:
    - schema_migrations table exists after ensure_schema
    - Tracked version matches SCHEMA_VERSION
    - Only one version row exists (not accumulated from repeated calls)
  - Verified: make test (12 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - db.py uses DELETE + INSERT pattern for set_schema_version (single-row tracking, not append)
  - get_schema_version returns 0 if schema_migrations table doesn't exist yet
  - ensure_schema has downgrade protection: raises RuntimeError if DB version > code version
  - Phase 0 DB layer was fully pre-built; just needed explicit test for version tracking AC
---

## Iteration 6 — US-101: Define OHLCV data model
- What was done:
  - Created src/smaps/models.py with OHLCVBar frozen dataclass (slots=True)
  - Fields: ticker (str), date (datetime.date), open/high/low/close (float), volume (int)
  - __post_init__ validation: high >= low, volume >= 0
  - Created tests/test_models.py with 5 tests:
    - test_create_valid_bar: verifies all fields
    - test_create_bar_high_equals_low: edge case (flat day)
    - test_validation_high_less_than_low: rejects invalid high/low
    - test_validation_negative_volume: rejects negative volume
    - test_bar_is_frozen: confirms immutability
  - Verified: make test (17 passed), make typecheck (success)
- Files affected: src/smaps/models.py (new), tests/test_models.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - frozen=True + slots=True on dataclass gives immutability + memory efficiency
  - __post_init__ works with frozen dataclasses for validation (runs before freeze)
  - volume is int (not float) since it represents share count
  - First Phase 1 file — models.py will be imported by collectors and features later
---

## Iteration 7 — US-102: Implement Yahoo Finance daily downloader
- What was done:
  - Created src/smaps/collectors/ package with __init__.py
  - Created src/smaps/collectors/price.py with fetch_daily_bars(ticker, start, end) -> list[OHLCVBar]
  - Uses yfinance.download() with auto_adjust=True, progress=False
  - End date offset by +1 day since yfinance end is exclusive
  - Created tests/test_collectors_price.py with 5 mocked tests:
    - test_returns_ohlcv_bars: verifies list[OHLCVBar] return type
    - test_parses_fields_correctly: verifies field mapping from DataFrame
    - test_empty_response: handles empty DataFrame gracefully
    - test_passes_auto_adjust: verifies auto_adjust=True kwarg
    - test_ticker_propagated: verifies ticker field set on all bars
  - Added yfinance>=0.2 to pyproject.toml dependencies
  - Added [[tool.mypy.overrides]] for yfinance.* to ignore_missing_imports (no py.typed)
  - Verified: make test (22 passed), make typecheck (success)
- Files affected: src/smaps/collectors/__init__.py (new), src/smaps/collectors/price.py (new), tests/test_collectors_price.py (new), pyproject.toml, PRD.md, progress.txt
- Learnings for next cycles:
  - yfinance has no py.typed marker; need mypy overrides with ignore_missing_imports = true
  - mypy cache can become stale after pyproject.toml config changes; clear .mypy_cache if overrides don't take effect
  - yfinance.download() end date is exclusive; add +1 day timedelta for inclusive end
  - Use @patch("smaps.collectors.price.yf.download") to mock at the module level where it's imported
  - DataFrame.iterrows() yields (Timestamp, Series) tuples; call .date() on timestamp for datetime.date
---

## Iteration 8 — US-103: Add OHLCV table and idempotent upsert
- What was done:
  - Updated migration_001 in migrations.py: removed `adj_close` column (not in OHLCVBar model since auto_adjust=True), changed volume from REAL to INTEGER to match OHLCVBar.volume (int)
  - Added `upsert_bars(conn, bars) -> int` function to db.py using INSERT OR REPLACE
  - Stores date as ISO text (YYYY-MM-DD) for SQLite compatibility
  - Created tests/test_ohlcv_persistence.py with 4 tests:
    - test_upsert_inserts_bar: verifies single bar round-trip
    - test_upsert_same_row_twice_yields_single_row: core AC — same PK twice → 1 row, second value wins
    - test_upsert_multiple_bars: verifies batch insert of 3 bars
    - test_upsert_empty_list: edge case — empty list succeeds
  - Fixed existing column-check tests in test_smoke.py and test_migrations.py to remove adj_close
  - Verified: make test (26 passed), make typecheck (success)
- Files affected: src/smaps/migrations.py, src/smaps/db.py, tests/test_ohlcv_persistence.py (new), tests/test_smoke.py, tests/test_migrations.py, PRD.md, progress.txt
- Learnings for next cycles:
  - Original scaffold migration_001 had adj_close from pre-PRD era; safe to modify since no production DB exists
  - INSERT OR REPLACE on composite PK (ticker, date) is the idiomatic SQLite upsert for this pattern
  - Store datetime.date as ISO string via .isoformat() — SQLite has no native date type
  - executemany() is efficient for batch inserts; commit once after the batch
---

## Iteration 9 — US-104: Implement sentiment data collector
- What was done:
  - Added SentimentScore frozen dataclass to src/smaps/models.py with validation (score clamped to -1..1)
  - Created src/smaps/collectors/sentiment.py with fetch_sentiment(ticker, date) -> SentimentScore
  - Uses Google News RSS feed as free data source (no API key needed)
  - Keyword-based headline sentiment heuristic: positive/negative word sets, averaged across headlines
  - _score_headline() scores individual headlines; _fetch_rss() fetches RSS XML
  - Created tests/test_collectors_sentiment.py with 10 tests:
    - TestScoreHeadline: positive, negative, neutral, mixed headlines, score range
    - TestFetchSentiment: returns SentimentScore, positive/negative/empty feed, valid range
  - All tests use mocked urlopen (no live HTTP calls)
  - Verified: make test (36 passed), make typecheck (success)
- Files affected: src/smaps/models.py, src/smaps/collectors/sentiment.py (new), tests/test_collectors_sentiment.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - Google News RSS is a free, no-auth-needed source for stock headlines: news.google.com/rss/search?q=TICKER+stock
  - urlopen returns a context manager; mock both __enter__/__exit__ and .read() for testing
  - Keyword-based sentiment is a reasonable baseline; can be upgraded to NLP later
  - SentimentScore.source field enables multiple providers in future (e.g., Reddit, Twitter)
  - xml.etree.ElementTree.fromstring() + .iter("title") is the simplest way to extract RSS titles
---
