# Progress Log

## Learnings
(Notes discovered during implementation)

## Decisions
- PRD rewritten from scratch with expanded scope: price + sentiment + fundamentals data sources
- Story IDs reset to US-001..US-703 (no phase prefix in Phase 0, phase-prefixed from Phase 1 onward)
- ML retraining is core to the system (Phase 5), not optional

## Integration Notes
(Cross-story dependencies and gotchas)

## Next Smallest Task
- US-205: Combine all features into unified vector

---

## Iteration 1 — US-001: Create project skeleton
- What was done:
  - Created tests/conftest.py (was missing from scaffold)
  - Fixed mypy type error in migrations.py: `callable` → `Callable[[sqlite3.Connection], None]`
  - Added py.typed marker to src/smaps/ for mypy PEP 561 compliance
  - Added [tool.mypy] config to pyproject.toml (mypy_path, explicit_package_bases)
  - Verified: pip install -e . succeeds, mypy passes, all 9 tests pass
- Files affected: tests/conftest.py, src/smaps/migrations.py, src/smaps/py.typed, pyproject.toml, PRD.md
- Learnings for next cycles:
  - src layout + editable install causes mypy "found twice" error; fix with mypy_path = "src" + explicit_package_bases = true
  - Phase 0 scaffold was already largely built but PRD checkboxes were never ticked after rewrite
  - Use `Callable` from typing, not builtin `callable`, as a type annotation
---

## Iteration 2 — US-002: Add Makefile with test and lint targets
- What was done:
  - Added `lint` target (`ruff check src/ tests/`) and `typecheck` target (`mypy src/`) to Makefile
  - Added `ruff>=0.4` and `mypy>=1.0` to `[project.optional-dependencies] dev` in pyproject.toml
  - Removed stale pre-rewrite files from src/ root (learner.py, predictor.py, scheduler.py, validator.py, __init__.py) that were causing mypy failures — these were from the old project structure before the PRD rewrite
  - Verified: `make test` (9 passed), `make lint` (all checks passed), `make typecheck` (success) all exit 0
- Files affected: Makefile, pyproject.toml, PRD.md, src/__init__.py (deleted), src/learner.py (deleted), src/predictor.py (deleted), src/scheduler.py (deleted), src/validator.py (deleted)
- Learnings for next cycles:
  - Stale files in src/ root from pre-rewrite era cause mypy to fail; they were safely removed since the package lives at src/smaps/
  - ruff is a fast Python linter with zero config needed for basic linting
  - Makefile .PHONY list must include all non-file targets
---

## Iteration 3 — US-003: Add config loader with environment variable support
- What was done:
  - .env.example already existed with SMAPS_TICKERS, SMAPS_DB_PATH, SMAPS_LOG_LEVEL
  - src/smaps/config.py already existed with Settings class using pydantic-settings BaseSettings
  - test_config_defaults already existed verifying Settings() works with no env vars
  - Added test_config_env_overrides to verify SMAPS_* env var overrides work (monkeypatch)
  - Verified: make test (10 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - Many Phase 0 stories were pre-built during scaffold but lacked tests for all acceptance criteria
  - pydantic-settings BaseSettings with env_prefix handles env var parsing including JSON lists
  - monkeypatch.setenv is the clean way to test env var overrides in pytest
---

## Iteration 4 — US-004: Add structured logging with run_id
- What was done:
  - src/smaps/logging.py already existed with get_logger(name, run_id=None)
  - Format already included ISO timestamp (%Y-%m-%dT%H:%M:%S), level, name, and run_id
  - Existing test_get_logger verified name but not isinstance; added isinstance(logger, logging.Logger) checks
  - Added test_get_logger_output_format that captures stderr and verifies ISO timestamp, level, name, run_id, and message are all present in output
  - Verified: make test (11 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - logging.StreamHandler writes to stderr by default; use capfd to capture it
  - Use unique logger names in tests to avoid handler reuse from Python's global logger registry
  - Phase 0 modules were pre-built but needed AC-level test coverage to be marked complete
---

## Iteration 5 — US-005: Add SQLite database layer with schema migrations
- What was done:
  - db.py already exported get_connection(db_path) and ensure_schema(conn)
  - migrations.py already had sequential migration list with Callable types
  - schema_migrations table already created with version tracking
  - ensure_schema already idempotent (CREATE TABLE IF NOT EXISTS + version check)
  - Existing tests verified table creation and idempotency
  - Added test_schema_migrations_tracks_version to explicitly verify:
    - schema_migrations table exists after ensure_schema
    - Tracked version matches SCHEMA_VERSION
    - Only one version row exists (not accumulated from repeated calls)
  - Verified: make test (12 passed), make typecheck (success)
- Files affected: tests/test_smoke.py, PRD.md, progress.txt
- Learnings for next cycles:
  - db.py uses DELETE + INSERT pattern for set_schema_version (single-row tracking, not append)
  - get_schema_version returns 0 if schema_migrations table doesn't exist yet
  - ensure_schema has downgrade protection: raises RuntimeError if DB version > code version
  - Phase 0 DB layer was fully pre-built; just needed explicit test for version tracking AC
---

## Iteration 6 — US-101: Define OHLCV data model
- What was done:
  - Created src/smaps/models.py with OHLCVBar frozen dataclass (slots=True)
  - Fields: ticker (str), date (datetime.date), open/high/low/close (float), volume (int)
  - __post_init__ validation: high >= low, volume >= 0
  - Created tests/test_models.py with 5 tests:
    - test_create_valid_bar: verifies all fields
    - test_create_bar_high_equals_low: edge case (flat day)
    - test_validation_high_less_than_low: rejects invalid high/low
    - test_validation_negative_volume: rejects negative volume
    - test_bar_is_frozen: confirms immutability
  - Verified: make test (17 passed), make typecheck (success)
- Files affected: src/smaps/models.py (new), tests/test_models.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - frozen=True + slots=True on dataclass gives immutability + memory efficiency
  - __post_init__ works with frozen dataclasses for validation (runs before freeze)
  - volume is int (not float) since it represents share count
  - First Phase 1 file — models.py will be imported by collectors and features later
---

## Iteration 7 — US-102: Implement Yahoo Finance daily downloader
- What was done:
  - Created src/smaps/collectors/ package with __init__.py
  - Created src/smaps/collectors/price.py with fetch_daily_bars(ticker, start, end) -> list[OHLCVBar]
  - Uses yfinance.download() with auto_adjust=True, progress=False
  - End date offset by +1 day since yfinance end is exclusive
  - Created tests/test_collectors_price.py with 5 mocked tests:
    - test_returns_ohlcv_bars: verifies list[OHLCVBar] return type
    - test_parses_fields_correctly: verifies field mapping from DataFrame
    - test_empty_response: handles empty DataFrame gracefully
    - test_passes_auto_adjust: verifies auto_adjust=True kwarg
    - test_ticker_propagated: verifies ticker field set on all bars
  - Added yfinance>=0.2 to pyproject.toml dependencies
  - Added [[tool.mypy.overrides]] for yfinance.* to ignore_missing_imports (no py.typed)
  - Verified: make test (22 passed), make typecheck (success)
- Files affected: src/smaps/collectors/__init__.py (new), src/smaps/collectors/price.py (new), tests/test_collectors_price.py (new), pyproject.toml, PRD.md, progress.txt
- Learnings for next cycles:
  - yfinance has no py.typed marker; need mypy overrides with ignore_missing_imports = true
  - mypy cache can become stale after pyproject.toml config changes; clear .mypy_cache if overrides don't take effect
  - yfinance.download() end date is exclusive; add +1 day timedelta for inclusive end
  - Use @patch("smaps.collectors.price.yf.download") to mock at the module level where it's imported
  - DataFrame.iterrows() yields (Timestamp, Series) tuples; call .date() on timestamp for datetime.date
---

## Iteration 8 — US-103: Add OHLCV table and idempotent upsert
- What was done:
  - Updated migration_001 in migrations.py: removed `adj_close` column (not in OHLCVBar model since auto_adjust=True), changed volume from REAL to INTEGER to match OHLCVBar.volume (int)
  - Added `upsert_bars(conn, bars) -> int` function to db.py using INSERT OR REPLACE
  - Stores date as ISO text (YYYY-MM-DD) for SQLite compatibility
  - Created tests/test_ohlcv_persistence.py with 4 tests:
    - test_upsert_inserts_bar: verifies single bar round-trip
    - test_upsert_same_row_twice_yields_single_row: core AC — same PK twice → 1 row, second value wins
    - test_upsert_multiple_bars: verifies batch insert of 3 bars
    - test_upsert_empty_list: edge case — empty list succeeds
  - Fixed existing column-check tests in test_smoke.py and test_migrations.py to remove adj_close
  - Verified: make test (26 passed), make typecheck (success)
- Files affected: src/smaps/migrations.py, src/smaps/db.py, tests/test_ohlcv_persistence.py (new), tests/test_smoke.py, tests/test_migrations.py, PRD.md, progress.txt
- Learnings for next cycles:
  - Original scaffold migration_001 had adj_close from pre-PRD era; safe to modify since no production DB exists
  - INSERT OR REPLACE on composite PK (ticker, date) is the idiomatic SQLite upsert for this pattern
  - Store datetime.date as ISO string via .isoformat() — SQLite has no native date type
  - executemany() is efficient for batch inserts; commit once after the batch
---

## Iteration 9 — US-104: Implement sentiment data collector
- What was done:
  - Added SentimentScore frozen dataclass to src/smaps/models.py with validation (score clamped to -1..1)
  - Created src/smaps/collectors/sentiment.py with fetch_sentiment(ticker, date) -> SentimentScore
  - Uses Google News RSS feed as free data source (no API key needed)
  - Keyword-based headline sentiment heuristic: positive/negative word sets, averaged across headlines
  - _score_headline() scores individual headlines; _fetch_rss() fetches RSS XML
  - Created tests/test_collectors_sentiment.py with 10 tests:
    - TestScoreHeadline: positive, negative, neutral, mixed headlines, score range
    - TestFetchSentiment: returns SentimentScore, positive/negative/empty feed, valid range
  - All tests use mocked urlopen (no live HTTP calls)
  - Verified: make test (36 passed), make typecheck (success)
- Files affected: src/smaps/models.py, src/smaps/collectors/sentiment.py (new), tests/test_collectors_sentiment.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - Google News RSS is a free, no-auth-needed source for stock headlines: news.google.com/rss/search?q=TICKER+stock
  - urlopen returns a context manager; mock both __enter__/__exit__ and .read() for testing
  - Keyword-based sentiment is a reasonable baseline; can be upgraded to NLP later
  - SentimentScore.source field enables multiple providers in future (e.g., Reddit, Twitter)
  - xml.etree.ElementTree.fromstring() + .iter("title") is the simplest way to extract RSS titles
---

## Iteration 10 — US-105: Add sentiment table and persistence
- What was done:
  - Added migration_002_sentiment to migrations.py creating `sentiment_daily` table with PK (ticker, date, source)
  - Bumped SCHEMA_VERSION from 1 to 2 in db.py
  - Added `upsert_sentiment(conn, scores) -> int` function to db.py using INSERT OR REPLACE
  - Imported SentimentScore into db.py alongside OHLCVBar
  - Created tests/test_sentiment_persistence.py with 5 tests:
    - test_upsert_inserts_sentiment: verifies single score round-trip
    - test_upsert_same_row_twice_yields_single_row: core AC — same PK twice → 1 row, second value wins
    - test_upsert_multiple_scores: verifies batch insert of 3 scores
    - test_upsert_different_sources_same_ticker_date: verifies different sources coexist (composite PK)
    - test_upsert_empty_list: edge case — empty list succeeds
  - Verified: make test (41 passed), make typecheck (success)
- Files affected: src/smaps/migrations.py, src/smaps/db.py, tests/test_sentiment_persistence.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - SCHEMA_VERSION bump is safe because existing tests reference it dynamically via import
  - Composite PK (ticker, date, source) allows multiple sentiment providers for the same ticker+date
  - INSERT OR REPLACE on composite PK is the same idempotent upsert pattern used for ohlcv_daily
  - Migration pattern is consistent: add function, add to MIGRATIONS list, bump SCHEMA_VERSION
---

## Iteration 11 — US-106: Implement fundamentals data collector
- What was done:
  - Added Fundamentals frozen dataclass to src/smaps/models.py with fields: ticker, date, pe_ratio, market_cap, eps, revenue (all optional floats except ticker/date)
  - Created src/smaps/collectors/fundamentals.py with fetch_fundamentals(ticker) -> Fundamentals
  - Uses yfinance Ticker(ticker).info to retrieve trailingPE, marketCap, trailingEps, totalRevenue
  - Helper _float_or_none() safely converts values, returning None for missing/non-numeric data
  - Created tests/test_collectors_fundamentals.py with 6 mocked tests:
    - test_returns_fundamentals: verifies Fundamentals return type
    - test_parses_all_fields: verifies field mapping from info dict
    - test_partial_info_returns_none_for_missing: missing keys → None
    - test_empty_info_all_none: no fundamental keys → all None
    - test_ticker_passed_to_yfinance: verifies yf.Ticker() called with correct ticker
    - test_non_numeric_value_returns_none: "N/A" and non-numeric strings → None
  - Verified: make test (47 passed), make typecheck (success)
- Files affected: src/smaps/models.py, src/smaps/collectors/fundamentals.py (new), tests/test_collectors_fundamentals.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - yfinance Ticker.info returns a dict[str, Any]; key names are camelCase (trailingPE, marketCap, trailingEps, totalRevenue)
  - Info dict may contain "N/A" strings or None for missing metrics; always guard with try/except on float()
  - Fundamentals uses date=datetime.date.today() since yfinance .info returns current snapshot, not historical
  - Mock yf.Ticker at module level: @patch("smaps.collectors.fundamentals.yf.Ticker")
  - Fundamentals dataclass uses Optional[float] (float | None) for all metric fields since any can be unavailable
---

## Iteration 12 — US-107: Add fundamentals table and persistence
- What was done:
  - Added migration_003_fundamentals to migrations.py creating `fundamentals_daily` table with PK (ticker, date)
  - Columns: ticker (TEXT), date (TEXT), pe_ratio (REAL), market_cap (REAL), eps (REAL), revenue (REAL)
  - Bumped SCHEMA_VERSION from 2 to 3 in db.py
  - Added `upsert_fundamentals(conn, rows) -> int` function to db.py using INSERT OR REPLACE
  - Imported Fundamentals into db.py alongside OHLCVBar and SentimentScore
  - Created tests/test_fundamentals_persistence.py with 5 tests:
    - test_upsert_inserts_fundamentals: verifies single row round-trip with all fields
    - test_upsert_same_row_twice_yields_single_row: core AC — same PK twice → 1 row, second value wins
    - test_upsert_multiple_fundamentals: verifies batch insert of 3 rows
    - test_upsert_with_none_fields: verifies None/Optional fields stored as NULL
    - test_upsert_empty_list: edge case — empty list succeeds
  - Verified: make test (52 passed), make typecheck (success)
- Files affected: src/smaps/migrations.py, src/smaps/db.py, tests/test_fundamentals_persistence.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - Fundamentals PK is (ticker, date) — simpler than sentiment which has (ticker, date, source) composite
  - All metric columns are nullable REAL since Fundamentals fields are Optional[float]
  - None values in Python pass through to SQLite as NULL via executemany without special handling
  - Migration pattern remains consistent: add function, add to MIGRATIONS list, bump SCHEMA_VERSION
  - Phase 1 data collection is now complete (US-101 through US-107); US-108 orchestrator is next
---

## Iteration 13 — US-108: Add multi-ticker ingestion orchestrator
- What was done:
  - Created src/smaps/collectors/ingest.py with `ingest_all(tickers, start, end, db_path)` function
  - Calls fetch_daily_bars, fetch_sentiment, fetch_fundamentals for each ticker
  - Error in one ticker is caught and logged; does not block other tickers
  - Returns dict with "succeeded" and "failed" ticker lists for caller visibility
  - Each collector step logged with timing via time.monotonic()
  - Private helper `_ingest_ticker()` handles single-ticker orchestration
  - Created tests/test_ingest.py with 5 tests:
    - test_ingest_all_succeeds_for_multiple_tickers: all tickers succeed
    - test_error_in_one_ticker_does_not_block_others: failing ticker isolated
    - test_calls_all_three_collectors_per_ticker: verifies call args
    - test_empty_ticker_list: edge case — no tickers
    - test_data_persisted_to_database: end-to-end flow completes
  - All external calls mocked (no live API calls in tests)
  - Verified: make test (57 passed), make typecheck (success)
- Files affected: src/smaps/collectors/ingest.py (new), tests/test_ingest.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - @patch decorators stack in reverse order as function parameters (outermost decorator = last param)
  - time.monotonic() is the correct timer for elapsed-time measurement (not affected by system clock changes)
  - Return value dict pattern (succeeded/failed) makes orchestrator testable without DB inspection
  - Phase 1 data collection is now fully complete (US-101 through US-108); Phase 2 feature engineering is next
---

## Iteration 14 — US-201: Define feature pipeline interface
- What was done:
  - Created src/smaps/features/ package with __init__.py
  - Created src/smaps/features/pipeline.py with FeaturePipeline Protocol class
  - Protocol defines `transform(ticker, as_of_date) -> dict[str, float]` method
  - Docstring specifies no-future-data contract: only data dated <= as_of_date may be used
  - Created tests/test_feature_pipeline.py with 3 tests:
    - test_dummy_implements_protocol: concrete class satisfies FeaturePipeline type annotation
    - test_transform_returns_dict_of_floats: verifies return type contract
    - test_protocol_is_runtime_checkable_via_typing: verifies structural subtyping via hasattr
  - Verified: make test (60 passed), make typecheck (success)
- Files affected: src/smaps/features/__init__.py (new), src/smaps/features/pipeline.py (new), tests/test_feature_pipeline.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - typing.Protocol provides structural subtyping — no explicit inheritance required from implementors
  - Protocol methods use `...` (Ellipsis) as body, not `pass`, per convention
  - FeaturePipeline is the base interface for US-202 (technical), US-203 (sentiment), US-204 (fundamental) features
  - First Phase 2 file — features/ package will be the home for all feature engineering code
  - Next stories (US-202..US-204) will create concrete implementations of this protocol
---

## Iteration 15 — US-202: Implement technical indicator features
- What was done:
  - Created src/smaps/features/technical.py with TechnicalFeatures class implementing FeaturePipeline protocol
  - Takes sqlite3.Connection in constructor; queries ohlcv_daily table filtered by date <= as_of_date
  - Computes 7 features: return_1d, return_5d, return_10d, ma_ratio_5_20, volume_change_1d, volatility_20d, rsi_14
  - All indicators return float('nan') when insufficient data is available
  - RSI uses simple average gain/loss method (SMA-based RSI)
  - No-leakage: SQL WHERE clause restricts to date <= as_of_date.isoformat()
  - Created tests/test_features_technical.py with 11 tests:
    - test_output_keys_and_shape: verifies all 7 keys returned as floats
    - test_return_1d: verifies 1-day return calculation
    - test_return_5d: verifies 5-day return calculation
    - test_return_10d: verifies 10-day return calculation
    - test_volume_change_1d: verifies volume change calculation
    - test_rsi_all_gains: RSI = 100 when all changes positive
    - test_rsi_all_losses: RSI = 0 when all changes negative
    - test_ma_ratio_5_20: verifies MA(5)/MA(20) ratio
    - test_no_leakage: future bars excluded by as_of_date filter
    - test_insufficient_data_returns_nan: 1 bar → all NaN
    - test_no_bars_returns_nan: unknown ticker → all NaN
  - Verified: make test (71 passed), make typecheck (success)
- Files affected: src/smaps/features/technical.py (new), tests/test_features_technical.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - float('nan') is a valid Python float; use math.isnan() to check in tests
  - SQL date comparison works on ISO strings (YYYY-MM-DD) in SQLite for <= filtering
  - TechnicalFeatures needs DB connection passed in constructor — same pattern will apply to SentimentFeatures and FundamentalFeatures
  - _return_n() is reusable for both price returns and volume change (same formula)
  - RSI edge cases: all gains → 100.0 (avg_loss=0 guard), all losses → 0.0 (natural from formula)
  - volatility_20d uses sample stdev (N-1 denominator) of daily returns over last 20 bars
---

## Iteration 16 — US-203: Implement sentiment features
- What was done:
  - Created src/smaps/features/sentiment.py with SentimentFeatures class implementing FeaturePipeline protocol
  - Takes sqlite3.Connection in constructor; queries sentiment_daily table filtered by date <= as_of_date
  - Computes 2 features: latest_sentiment_score, sentiment_ma_5d (5-day rolling average)
  - Gracefully returns 0.0 for both features when no sentiment data available
  - _rolling_avg() helper averages last N scores, or all available if fewer than N
  - No-leakage: SQL WHERE clause restricts to date <= as_of_date.isoformat()
  - Created tests/test_features_sentiment.py with 7 tests:
    - test_output_keys_and_types: verifies both keys returned as floats
    - test_latest_sentiment_score: verifies most recent score is returned
    - test_latest_sentiment_score_respects_as_of_date: future scores excluded
    - test_sentiment_ma_5d_with_enough_data: verifies 5-day rolling average
    - test_sentiment_ma_5d_with_fewer_than_5: averages all available when < 5
    - test_no_data_returns_zeros: both features return 0.0 for unknown ticker
    - test_no_data_for_ticker_but_other_tickers_exist: isolation between tickers
  - Verified: make test (78 passed), make typecheck (success)
- Files affected: src/smaps/features/sentiment.py (new), tests/test_features_sentiment.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - SentimentFeatures follows exact same pattern as TechnicalFeatures: conn in __init__, SQL query with date <= as_of_date
  - sentiment_daily table may have multiple sources per (ticker, date); SQL query returns all rows — this means scores list may include multiple scores per day
  - 0.0 is the graceful fallback for missing sentiment data (not NaN like technical features) since 0.0 represents neutral sentiment
  - _rolling_avg uses values[-window:] slicing which safely returns fewer items when len < window
  - US-204 (fundamental features) will follow the same pattern with fundamentals_daily table
---

## Iteration 17 — US-204: Implement fundamental features
- What was done:
  - Created src/smaps/features/fundamental.py with FundamentalFeatures class implementing FeaturePipeline protocol
  - Takes sqlite3.Connection in constructor; queries fundamentals_daily table filtered by date <= as_of_date
  - Computes 3 features: pe_ratio, eps, market_cap (latest available values via ORDER BY date DESC LIMIT 1)
  - Gracefully returns float('nan') for missing fields (None in DB → NaN) and when no data exists
  - _load_latest() helper fetches the single most recent row for the ticker
  - Created tests/test_features_fundamental.py with 8 tests:
    - test_output_keys_and_types: verifies all 3 keys returned as floats
    - test_pe_ratio_value: verifies pe_ratio from latest row
    - test_eps_value: verifies eps from latest row
    - test_market_cap_value: verifies market_cap from latest row
    - test_latest_row_used: multiple rows → picks most recent <= as_of_date
    - test_none_fields_return_nan: individual None fields → NaN
    - test_no_data_returns_all_nan: unknown ticker → all NaN
    - test_no_data_for_ticker_but_other_tickers_exist: isolation between tickers
  - Verified: make test (86 passed), make typecheck (success)
- Files affected: src/smaps/features/fundamental.py (new), tests/test_features_fundamental.py (new), PRD.md, progress.txt
- Learnings for next cycles:
  - FundamentalFeatures uses ORDER BY date DESC LIMIT 1 pattern (single latest row) vs SentimentFeatures which loads all rows for rolling computation
  - NaN (not 0.0) is the appropriate fallback for fundamentals since 0.0 would be a misleading value for pe_ratio, eps, market_cap
  - fundamentals_daily PK is (ticker, date) — no source dimension unlike sentiment
  - SQLite returns None for NULL columns; convert with `float(x) if x is not None else float("nan")`
  - US-205 (combine all features) is next — will merge TechnicalFeatures + SentimentFeatures + FundamentalFeatures
---
